<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" type="text/css" href="static/css/style.css" />

    <title>GönnBuzz - Hosting</title>
  </head>

  <body>
    <section class="container">
      <div class="box box-1">
        <h1>GönnBuzz - Host</h1>
      </div>

      <div class="box box-2 red clickableHint" id="reset">
        RESET ALL
      </div>

      <div class="box-3">
        <table id="timestampsTable">
          <thead>
            <tr>
              <th>Pos #</th>
              <th>Name</th>
              <th>Time</th>
              <th>Offset [ms]</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="debugcontainer">
      <div class="debugbox" id="debugtime"></div>
      <div class="debugbox" id="debugsync"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="/timesync/timesync.js"></script>
    <script>
      // create a timesync instance
      var ts = timesync.create({
        server: "/timesync",
        interval: 1000,
      });

      ts.on("change", function (offset) {
        $("#debugsync").text("tcorrection: " + offset + " ms");
      });

      // get synchronized time
      setInterval(function () {
        var now = new Date(ts.now());
        $("#debugtime").text("now: " + now.toISOString() + " ms");
      }, 20);

      $(function () {
        var socket = io();

        function clearTimestampList() {
          $("#timestamps").empty();
          $("#timestampsTable tbody > tr").remove();
        }

        function resetHandler() {
          socket.emit("reset");
          return false;
        }

        $("#reset").on("click", resetHandler);

        socket.on("timestampList", function (serverTimestampList) {
          clearTimestampList();

          let index = 1;
          serverTimestampList.forEach((serverTimestamp) => {
            const clientDate = new Date(serverTimestamp.clientTimestamp);
            $("#timestampsTable").append(
              "<tr><td>" +
                index.toString() +
                "</td><td>" +
                serverTimestamp.clientName +
                "</td><td>" +
                clientDate.toLocaleTimeString() +
                "</td><td>" +
                serverTimestamp.offset.toString() +
                "</td></tr>"
            );
            index++;
          });
        });

        socket.on("reset", function () {
          clearTimestampList();
        });

        socket.on("reload", function () {
          window.location.reload();
        });
      });
    </script>
  </body>
</html>
